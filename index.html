<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Badminton Picker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:15px; background:#f4f6f8; }
h1{text-align:center;}
.card{background:white; padding:15px; border-radius:14px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05);}
textarea,input{width:100%; font-size:16px; padding:10px; border-radius:10px; border:1px solid #ddd;}
button{width:100%; font-size:22px; padding:18px; border:none; border-radius:16px; background:#1e88e5; color:white; margin-top:10px;}
button:active{transform:scale(0.98);}
.court{font-size:18px; margin-bottom:10px;}
.sitout{color:#d32f2f; font-weight:600;}
.hidden{display:none;}
</style>
</head>
<body>

<h1>üè∏ Badminton Picker</h1>

<div id="setup" class="card">
  <p><b>Players (one per line)</b></p>
  <textarea id="playersInput" rows="6"></textarea>

  <p><b>Number of courts</b></p>
  <input id="courtsInput" type="number" min="1" value="1">

  <button onclick="start()">Start Games</button>
</div>

<div id="game" class="hidden">
  <div id="courts" class="card"></div>
  <div id="sitouts" class="card"></div>
  <button onclick="nextRound()">‚ñ∂ Next Round</button>
  <button onclick="reset()" style="background:#555;margin-top:15px;">Reset</button>
</div>

<script>
let allPlayers = [];
let activePlayers = [];
let courts = 1;
let sitouts = [];
let rotationRemaining = []; // players who haven't sat in this cycle
let lastSitouts = [];

function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];}}

function start(){
  let raw = document.getElementById("playersInput").value.trim();
  allPlayers = raw.split("\n").map(p=>p.trim()).filter(p=>p);
  activePlayers = [...allPlayers];

  if(activePlayers.length<4){
    alert("Need at least 4 players");
    return;
  }

  courts = parseInt(document.getElementById("courtsInput").value);
  let maxCourts = Math.floor(activePlayers.length / 4);
  if(courts > maxCourts){
    courts = maxCourts;
    alert("Not enough players for that many courts. Courts set to " + courts);
  }

  sitouts = [];
  rotationRemaining = [...activePlayers];
  lastSitouts = [];

  localStorage.setItem("badminton_players",JSON.stringify(allPlayers));
  localStorage.setItem("badminton_courts",courts);

  document.getElementById("setup").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  nextRound();
}

function nextRound(){
  let totalNeeded = courts * 4;
  let numSitOuts = activePlayers.length - totalNeeded;

  // If everyone fits on courts, nobody sits out
  if(numSitOuts <= 0){
    sitouts = [];
    lastSitouts = [];
    let pool = [...activePlayers];
    shuffle(pool);
    renderCourts(pool);
    renderSitouts();
    return;
  }

  // Step 1: reset rotation if not enough remaining
  if(rotationRemaining.length < numSitOuts){
    rotationRemaining = [...activePlayers];
  }

  // Step 2: shuffle remaining for randomness
  shuffle(rotationRemaining);

  sitouts = [];

  // Step 3: pick sit-outs avoiding last round if possible
  while(sitouts.length < numSitOuts){
    let idx = rotationRemaining.findIndex(p => !lastSitouts.includes(p));
    if(idx === -1) idx = 0; // unavoidable if all remaining were last round
    sitouts.push(rotationRemaining.splice(idx,1)[0]);
  }

  lastSitouts = [...sitouts];

  // Remove sit-outs from rotationRemaining for cycle
  rotationRemaining = rotationRemaining.filter(p => !sitouts.includes(p));

  // Remaining players play
  let pool = activePlayers.filter(p => !sitouts.includes(p));
  shuffle(pool);

  renderCourts(pool);
  renderSitouts();
}

function renderCourts(players){
  let html = "<h2>Courts</h2>";
  for(let i=0;i<courts;i++){
    let c = players.slice(i*4,i*4+4);
    if(c.length===4){
      html += `<div class="court"><b>Court ${i+1}</b>: ${c[0]} & ${c[1]} vs ${c[2]} & ${c[3]}</div>`;
    }
  }
  document.getElementById("courts").innerHTML = html;
}

function renderSitouts(){
  let html = "";
  if(sitouts.length===0){
    html += "<b>No one sitting out</b>";
  } else {
    html += `<b class="sitout">Sitting out (priority next game):</b><br>${sitouts.join(", ")}`;

    // Show players who haven't sat yet only if sit-outs exist
    if(rotationRemaining.length > 0){
      html += `<br><br><b>Players yet to sit out this rotation:</b><br>${rotationRemaining.join(", ")}`;
    }
  }

  document.getElementById("sitouts").innerHTML = html;
}

function reset(){
  if(confirm("Back to player selection?")){
    document.getElementById("game").classList.add("hidden");
    document.getElementById("setup").classList.remove("hidden");
  }
}

// Auto-load last players
let saved = JSON.parse(localStorage.getItem("badminton_players")||"null");
if(saved){
  document.getElementById("playersInput").value = saved.join("\n");
  document.getElementById("courtsInput").value = localStorage.getItem("badminton_courts")||1;
}
</script>

</body>
</html>
